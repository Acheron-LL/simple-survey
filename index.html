<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•é—®å·æµ‹è¯•</title>
    <style>
        body { font-family: "Microsoft YaHei", Arial; max-width: 500px; margin: 40px auto; padding: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #07c160; color: white; border: none; padding: 12px 30px; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #06ad56; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #message { margin-top: 20px; padding: 15px; border-radius: 4px; display: none; }
    </style>
</head>
<body>
    <h1>ğŸ“ ç®€å•é—®å·æµ‹è¯•</h1>
    <p style="color: #666; margin-bottom: 25px;">è¯·å¡«å†™ä»¥ä¸‹é—®å·ï¼Œæ‚¨çš„åé¦ˆå¯¹æˆ‘ä»¬éå¸¸é‡è¦ã€‚</p>
    
    <form id="surveyForm">
        <div class="form-group">
            <label for="name">æ‚¨çš„ç§°å‘¼ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <input type="text" id="name" name="name" placeholder="å¦‚ï¼šå¼ ä¸‰">
        </div>
        
        <div class="form-group">
            <label for="rating">æ‚¨çš„æ»¡æ„åº¦ï¼š<span style="color: red">*</span></label>
            <select id="rating" name="rating" required>
                <option value="">è¯·é€‰æ‹©æ»¡æ„åº¦</option>
                <option value="5">éå¸¸æ»¡æ„ â­â­â­â­â­</option>
                <option value="4">æ»¡æ„ â­â­â­â­</option>
                <option value="3">ä¸€èˆ¬ â­â­â­</option>
                <option value="2">ä¸æ»¡æ„ â­â­</option>
                <option value="1">éå¸¸ä¸æ»¡æ„ â­</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="feedback">æ‚¨çš„æ„è§æˆ–å»ºè®®ï¼š</label>
            <textarea id="feedback" name="feedback" rows="4" placeholder="è¯·å‘Šè¯‰æˆ‘ä»¬æ‚¨çš„æƒ³æ³•æˆ–å»ºè®®..."></textarea>
        </div>
        
        <button type="submit" id="submitBtn">æäº¤é—®å·</button>
    </form>
    
    <div id="message"></div>

    <!-- è…¾è®¯äº‘å¼€å‘ Web SDK -->
    <script src="https://imgcache.qq.com/qcloud/tcbjs/1.10.0/tcb.js"></script>
    
    <script>
        // ========== é…ç½®åŒºåŸŸ ==========
        // ä½ çš„è…¾è®¯äº‘å¼€å‘ç¯å¢ƒID
        const TCB_ENV_ID = 'lelouch-7g07h6d76934cbf';
        // ==============================
        
        console.log('æ­£åœ¨åˆå§‹åŒ–è…¾è®¯äº‘å¼€å‘ï¼Œç¯å¢ƒID:', TCB_ENV_ID);
        
        // åˆå§‹åŒ–è…¾è®¯äº‘å¼€å‘
        const app = tcb.init({
            env: TCB_ENV_ID,
            timeout: 10000
        });
        
        // è·å–æ•°æ®åº“å¼•ç”¨
        const db = app.database();
        const collection = db.collection('survey_responses');
        
        // è·å–DOMå…ƒç´ 
        const form = document.getElementById('surveyForm');
        const messageEl = document.getElementById('message');
        const submitBtn = document.getElementById('submitBtn');
        
        // è¡¨å•æäº¤å¤„ç†
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            const rating = document.getElementById('rating').value;
            if (!rating) {
                showMessage('è¯·é€‰æ‹©æ»¡æ„åº¦è¯„åˆ†ï¼', 'error');
                return;
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';
            
            // æ”¶é›†æ•°æ®
            const formData = new FormData(form);
            const data = {
                name: formData.get('name') || 'åŒ¿åç”¨æˆ·',
                rating: parseInt(rating),
                feedback: formData.get('feedback') || '',
                submitted_at: new Date(),
                createTime: new Date()
            };
            
            console.log('æäº¤æ•°æ®:', data);
            showMessage('æ­£åœ¨æäº¤æ•°æ®ï¼Œè¯·ç¨å€™...', 'loading');
            
            try {
                // æ’å…¥æ•°æ®åˆ°æ•°æ®åº“
                console.log('æ­£åœ¨è¿æ¥è…¾è®¯äº‘æ•°æ®åº“...');
                const result = await collection.add(data);
                
                console.log('âœ… æäº¤æˆåŠŸï¼Œæ–‡æ¡£ID:', result.id);
                showMessage('âœ… æäº¤æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å®è´µåé¦ˆã€‚', 'success');
                
                // é‡ç½®è¡¨å•
                form.reset();
                
                // 3ç§’åéšè—æˆåŠŸæ¶ˆæ¯
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('âŒ æäº¤å¤±è´¥:', error);
                
                // å‹å¥½çš„é”™è¯¯æç¤º
                let errorMsg = 'æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                if (error.message.includes('permission')) {
                    errorMsg = 'æ•°æ®åº“æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥é›†åˆæƒé™è®¾ç½®ã€‚';
                } else if (error.message.includes('network') || error.message.includes('Failed')) {
                    errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼š<br>1. å®‰å…¨åŸŸåæœªé…ç½®<br>2. ç½‘ç»œé—®é¢˜<br>3. åŸŸåé…ç½®æœªç”Ÿæ•ˆ';
                } else if (error.message.includes('env')) {
                    errorMsg = 'ç¯å¢ƒIDé…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥EnvIDã€‚';
                } else if (error.message.includes('collection')) {
                    errorMsg = 'æ•°æ®åº“é›†åˆä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥é›†åˆåç§°ã€‚';
                }
                
                showMessage(`âŒ ${errorMsg}<br><small>é”™è¯¯è¯¦æƒ…: ${error.message}</small>`, 'error');
                
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        
        // æ˜¾ç¤ºæ¶ˆæ¯çš„å‡½æ•°
        function showMessage(text, type = 'info') {
            messageEl.innerHTML = text;
            messageEl.style.display = 'block';
            
            const colors = {
                success: '#d4edda',
                error: '#f8d7da', 
                loading: '#fff3cd',
                info: '#d1ecf1'
            };
            
            messageEl.style.background = colors[type] || colors.info;
            messageEl.style.color = type === 'success' ? '#155724' : 
                                  type === 'error' ? '#721c24' : 
                                  type === 'loading' ? '#856404' : '#0c5460';
        }
        
        console.log('é—®å·ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    </script>
</body>
</html>
