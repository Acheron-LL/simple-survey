<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•é—®å·æµ‹è¯•</title>
    <style>
        body { font-family: Arial; max-width: 500px; margin: 40px auto; padding: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #07c160; color: white; border: none; padding: 12px 30px; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; margin-top: 10px; }
        button:hover { background: #06ad56; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #message { margin-top: 20px; padding: 15px; border-radius: 4px; display: none; }
        .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>ğŸ“ ç®€å•é—®å·æµ‹è¯•</h1>
    <p style="color: #666; margin-bottom: 25px;">æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼Œæ‚¨çš„åé¦ˆå¯¹æˆ‘ä»¬å¾ˆé‡è¦ï¼</p>
    
    <form id="surveyForm">
        <div class="form-group">
            <label for="name">æ‚¨çš„ç§°å‘¼ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <input type="text" id="name" name="name" placeholder="å¦‚ï¼šå¼ ä¸‰">
        </div>
        
        <div class="form-group">
            <label for="rating">æ‚¨çš„æ»¡æ„åº¦ï¼š<span style="color: red">*</span></label>
            <select id="rating" name="rating" required>
                <option value="">è¯·é€‰æ‹©æ»¡æ„åº¦</option>
                <option value="5">éå¸¸æ»¡æ„ â­â­â­â­â­</option>
                <option value="4">æ»¡æ„ â­â­â­â­</option>
                <option value="3">ä¸€èˆ¬ â­â­â­</option>
                <option value="2">ä¸æ»¡æ„ â­â­</option>
                <option value="1">éå¸¸ä¸æ»¡æ„ â­</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="feedback">æ‚¨çš„æ„è§æˆ–å»ºè®®ï¼š</label>
            <textarea id="feedback" name="feedback" rows="4" placeholder="è¯·å‘Šè¯‰æˆ‘ä»¬æ‚¨çš„æƒ³æ³•æˆ–å»ºè®®..."></textarea>
        </div>
        
        <button type="submit" id="submitBtn">
            <span id="btnText">æäº¤é—®å·</span>
        </button>
    </form>
    
    <div id="message"></div>

    <!-- è…¾è®¯äº‘å¼€å‘ SDK -->
    <script src="https://imgcache.qq.com/qcloud/tcbjs/2.10.2/tcb.js"></script>
    
    <script>
        // ============================================
        // è…¾è®¯äº‘å¼€å‘é…ç½®ï¼ˆä½¿ç”¨ä½ çš„æ­£ç¡®ä¿¡æ¯ï¼‰
        // ============================================
        const TCB_ENV_ID = 'lelouch-7g07h6d76934cbff'; // ä¸¤ä¸ªffç»“å°¾
        const TCB_REGION = 'ap-shanghai'; // ä¸Šæµ·åŒºåŸŸ
        // ============================================
        
        console.log('ğŸš€ å¯åŠ¨é—®å·ç³»ç»Ÿ');
        console.log('ç¯å¢ƒID:', TCB_ENV_ID);
        console.log('åŒºåŸŸ:', TCB_REGION);
        
        // å…¨å±€å˜é‡
        let app = null;
        let db = null;
        let isInitialized = false;
        
        // è·å–DOMå…ƒç´ 
        const form = document.getElementById('surveyForm');
        const messageEl = document.getElementById('message');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'info', duration = 0) {
            messageEl.innerHTML = text;
            messageEl.className = '';
            messageEl.classList.add(`message-${type}`);
            messageEl.style.display = 'block';
            
            messageEl.style.background = 
                type === 'success' ? '#d4edda' :
                type === 'error' ? '#f8d7da' :
                type === 'loading' ? '#fff3cd' : '#d1ecf1';
            
            messageEl.style.color = 
                type === 'success' ? '#155724' :
                type === 'error' ? '#721c24' :
                type === 'loading' ? '#856404' : '#0c5460';
            
            if (duration > 0) {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, duration);
            }
        }
        
        // è®¾ç½®æŒ‰é’®çŠ¶æ€
        function setButtonState(loading) {
            if (loading) {
                submitBtn.disabled = true;
                btnText.innerHTML = '<span class="loading-spinner"></span>æäº¤ä¸­...';
            } else {
                submitBtn.disabled = false;
                btnText.textContent = 'æäº¤é—®å·';
            }
        }
        
        // åˆå§‹åŒ–è…¾è®¯äº‘å¼€å‘
        async function initTCB() {
            if (isInitialized) return true;
            
            console.log('ğŸ” åˆå§‹åŒ–è…¾è®¯äº‘å¼€å‘...');
            
            try {
                // åˆå§‹åŒ–SDK
                app = tcb.init({
                    env: TCB_ENV_ID,
                    region: TCB_REGION,
                    timeout: 15000
                });
                
                console.log('âœ… SDKåˆå§‹åŒ–æˆåŠŸ');
                
                // åˆå§‹åŒ–æ•°æ®åº“
                db = app.database();
                console.log('âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ');
                
                isInitialized = true;
                return true;
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                showMessage(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        // è¡¨å•æäº¤å¤„ç†
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            const rating = document.getElementById('rating').value;
            if (!rating) {
                showMessage('è¯·é€‰æ‹©æ»¡æ„åº¦è¯„åˆ†ï¼', 'error', 3000);
                return;
            }
            
            // åˆå§‹åŒ–
            if (!isInitialized) {
                showMessage('æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...', 'loading');
                const success = await initTCB();
                if (!success) return;
            }
            
            // è®¾ç½®åŠ è½½çŠ¶æ€
            setButtonState(true);
            showMessage('æ­£åœ¨æäº¤æ‚¨çš„åé¦ˆ...', 'loading');
            
            // æ”¶é›†æ•°æ®
            const formData = new FormData(form);
            const data = {
                name: formData.get('name')?.trim() || 'åŒ¿åç”¨æˆ·',
                rating: parseInt(rating),
                feedback: formData.get('feedback')?.trim() || '',
                submitted_at: new Date(),
                createTime: new Date(),
                timestamp: Date.now(),
                userAgent: navigator.userAgent.substring(0, 100)
            };
            
            console.log('ğŸ“¤ æäº¤æ•°æ®:', data);
            
            try {
                // æ’å…¥æ•°æ®åˆ°æ•°æ®åº“
                console.log('ğŸ“¡ å†™å…¥æ•°æ®åº“...');
                
                const result = await db.collection('survey_responses').add(data);
                
                console.log('âœ… æäº¤æˆåŠŸï¼Œæ–‡æ¡£ID:', result.id);
                showMessage(`
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="font-size:24px;">ğŸ‰</div>
                        <div>
                            <strong>æäº¤æˆåŠŸï¼</strong><br>
                            æ„Ÿè°¢æ‚¨çš„å®è´µåé¦ˆï¼
                        </div>
                    </div>
                `, 'success');
                
                // é‡ç½®è¡¨å•
                form.reset();
                
                // 5ç§’åéšè—æ¶ˆæ¯
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
                
            } catch (error) {
                console.error('âŒ æäº¤å¤±è´¥:', error);
                
                let errorMsg = 'æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                
                if (error.message.includes('INVALID_ENV')) {
                    errorMsg = 'ç¯å¢ƒé…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç¯å¢ƒIDå’ŒåŒºåŸŸè®¾ç½®ã€‚';
                } else if (error.message.includes('permission') || error.message.includes('auth')) {
                    errorMsg = 'æƒé™é—®é¢˜ã€‚è¯·ç¡®ä¿ï¼š<br>1. å·²å¼€å¯åŒ¿åç™»å½•<br>2. æ•°æ®åº“æƒé™è®¾ç½®æ­£ç¡®';
                } else if (error.message.includes('network') || error.message.includes('Failed')) {
                    errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ã€‚<br>è¯·æ£€æŸ¥å®‰å…¨åŸŸåé…ç½®ã€‚';
                } else if (error.message.includes('collection')) {
                    errorMsg = 'æ•°æ®åº“é›†åˆä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥é›†åˆåç§°ã€‚';
                }
                
                showMessage(`
                    <strong>âŒ ${errorMsg}</strong><br>
                    <small>é”™è¯¯è¯¦æƒ…: ${error.message.substring(0, 150)}</small>
                `, 'error');
                
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                setButtonState(false);
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
            
            // å»¶è¿Ÿåˆå§‹åŒ–
            setTimeout(async () => {
                await initTCB();
            }, 1000);
        });
        
        console.log('ğŸ¯ é—®å·ç³»ç»Ÿè„šæœ¬åŠ è½½å®Œæˆ');
    </script>
</body>
</html>
