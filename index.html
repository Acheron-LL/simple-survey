<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•é—®å·æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", "Segoe UI", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-top: 20px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }
        
        label .required {
            color: #e74c3c;
            margin-left: 3px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
            background-color: #f8fafc;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #07c160 0%, #06ad56 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(7, 193, 96, 0.2);
        }
        
        .submit-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .submit-btn:disabled:hover {
            transform: none;
        }
        
        #message {
            margin-top: 25px;
            padding: 18px;
            border-radius: 8px;
            display: none;
            font-size: 15px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-success {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .message-error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .message-loading {
            background-color: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .message-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 14px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            body {
                padding: 15px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            input, textarea, select {
                padding: 10px 12px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ ç®€å•é—®å·æµ‹è¯•</h1>
        <p class="subtitle">æ‚¨çš„åé¦ˆå¯¹æˆ‘ä»¬éå¸¸é‡è¦ï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</p>
        
        <form id="surveyForm">
            <div class="form-group">
                <label for="name">
                    æ‚¨çš„ç§°å‘¼
                    <small style="color:#7f8c8d;font-weight:normal;">ï¼ˆå¯é€‰ï¼‰</small>
                </label>
                <input type="text" id="name" name="name" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“åæˆ–æ˜µç§°">
            </div>
            
            <div class="form-group">
                <label for="rating">
                    æ‚¨çš„æ»¡æ„åº¦
                    <span class="required">*</span>
                </label>
                <select id="rating" name="rating" required>
                    <option value="">è¯·é€‰æ‹©æ»¡æ„åº¦è¯„åˆ†</option>
                    <option value="5">éå¸¸æ»¡æ„ â­â­â­â­â­</option>
                    <option value="4">æ»¡æ„ â­â­â­â­</option>
                    <option value="3">ä¸€èˆ¬ â­â­â­</option>
                    <option value="2">ä¸æ»¡æ„ â­â­</option>
                    <option value="1">éå¸¸ä¸æ»¡æ„ â­</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="feedback">æ‚¨çš„æ„è§æˆ–å»ºè®®</label>
                <textarea id="feedback" name="feedback" 
                          placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„ä½“éªŒã€å»ºè®®æˆ–é‡åˆ°çš„é—®é¢˜..."></textarea>
                <div style="font-size:13px;color:#7f8c8d;margin-top:5px;">
                    æ‚¨çš„å»ºè®®å°†å¸®åŠ©æˆ‘ä»¬æ”¹è¿›æœåŠ¡
                </div>
            </div>
            
            <button type="submit" id="submitBtn" class="submit-btn">
                <span id="btnText">æäº¤é—®å·</span>
            </button>
        </form>
        
        <div id="message"></div>
        
        <div class="footer">
            <p>æœ¬é—®å·æ•°æ®å°†å®‰å…¨å­˜å‚¨äºè…¾è®¯äº‘æ•°æ®åº“</p>
            <p>å¦‚æœ‰é—®é¢˜ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•</p>
        </div>
    </div>

    <!-- è…¾è®¯äº‘å¼€å‘ SDK -->
    <script src="https://imgcache.qq.com/qcloud/tcbjs/1.10.0/tcb.js"></script>
    
    <script>
        // ============================================
        // è…¾è®¯äº‘å¼€å‘é…ç½®
        // è¯·ä¿®æ”¹ä¸ºä½ çš„ç¯å¢ƒID
        // ============================================
        const TCB_ENV_ID = 'lelouch-7g07h6d76934cbf';
        // ============================================
        
        console.log('ğŸš€ é—®å·ç³»ç»Ÿå¯åŠ¨ä¸­...');
        console.log('ç¯å¢ƒID:', TCB_ENV_ID);
        
        // å…¨å±€å˜é‡
        let app = null;
        let db = null;
        let collection = null;
        let isInitializing = false;
        
        // è·å–DOMå…ƒç´ 
        const form = document.getElementById('surveyForm');
        const messageEl = document.getElementById('message');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'info', duration = 0) {
            messageEl.innerHTML = text;
            messageEl.className = '';
            messageEl.classList.add(`message-${type}`);
            messageEl.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, duration);
            }
        }
        
        // è®¾ç½®æŒ‰é’®çŠ¶æ€
        function setButtonState(loading) {
            if (loading) {
                submitBtn.disabled = true;
                btnText.innerHTML = `<div class="loading-spinner"></div> æäº¤ä¸­...`;
            } else {
                submitBtn.disabled = false;
                btnText.textContent = 'æäº¤é—®å·';
            }
        }
        
        // åˆå§‹åŒ–è…¾è®¯äº‘å¼€å‘ï¼ˆåŒ…å«åŒ¿åç™»å½•ï¼‰
        async function initTCB() {
            if (isInitializing) {
                console.log('â³ æ­£åœ¨åˆå§‹åŒ–ä¸­ï¼Œè¯·ç­‰å¾…...');
                return false;
            }
            
            isInitializing = true;
            console.log('ğŸ” å¼€å§‹åˆå§‹åŒ–è…¾è®¯äº‘å¼€å‘...');
            
            try {
                // 1. åˆå§‹åŒ–SDK
                app = tcb.init({
                    env: TCB_ENV_ID,
                    timeout: 10000
                });
                
                console.log('âœ… SDKåˆå§‹åŒ–æˆåŠŸ');
                
                // 2. å°è¯•åŒ¿åç™»å½•
                console.log('ğŸ”‘ å°è¯•åŒ¿åç™»å½•...');
                showMessage('æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿï¼Œè¯·ç¨å€™...', 'loading');
                
                let authState = null;
                try {
                    // å…ˆæ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                    authState = await app.auth().getLoginState();
                    console.log('å½“å‰ç™»å½•çŠ¶æ€:', authState ? 'å·²ç™»å½•' : 'æœªç™»å½•');
                    
                    if (!authState) {
                        // æœªç™»å½•ï¼Œè¿›è¡ŒåŒ¿åç™»å½•
                        console.log('è¿›è¡ŒåŒ¿åç™»å½•...');
                        await app.auth().signInAnonymously();
                        authState = await app.auth().getLoginState();
                    }
                    
                    if (!authState) {
                        throw new Error('åŒ¿åç™»å½•å¤±è´¥ï¼Œæ— æ³•è·å–ç™»å½•çŠ¶æ€');
                    }
                    
                    console.log('âœ… åŒ¿åç™»å½•æˆåŠŸï¼Œç”¨æˆ·ID:', authState.user.uid);
                    
                } catch (loginError) {
                    console.error('âŒ ç™»å½•å¤±è´¥:', loginError);
                    
                    if (loginError.message.includes('anonymous') || 
                        loginError.message.includes('ç™»å½•æ–¹å¼') ||
                        loginError.message.includes('not enabled')) {
                        throw new Error(
                            'åŒ¿åç™»å½•åŠŸèƒ½æœªå¯ç”¨ã€‚<br>' +
                            'è¯·åˆ°è…¾è®¯äº‘æ§åˆ¶å° â†’ èº«ä»½è®¤è¯ â†’ ç™»å½•æ–¹å¼ â†’ å¯ç”¨"åŒ¿åç™»å½•"'
                        );
                    }
                    throw loginError;
                }
                
                // 3. åˆå§‹åŒ–æ•°æ®åº“
                console.log('ğŸ—ƒï¸ åˆå§‹åŒ–æ•°æ®åº“...');
                db = app.database();
                collection = db.collection('survey_responses');
                
                // æµ‹è¯•æ•°æ®åº“è¿æ¥
                try {
                    const testResult = await collection.limit(1).get();
                    console.log('âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸï¼Œç°æœ‰è®°å½•æ•°:', testResult.data.length);
                } catch (dbError) {
                    console.warn('æ•°æ®åº“æµ‹è¯•è­¦å‘Š:', dbError.message);
                    // ç»§ç»­ï¼Œå¯èƒ½åªæ˜¯é›†åˆä¸ºç©º
                }
                
                console.log('ğŸ‰ è…¾è®¯äº‘å¼€å‘åˆå§‹åŒ–å®Œæˆï¼');
                showMessage('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹å¡«å†™é—®å·ã€‚', 'info', 3000);
                
                return true;
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                
                let errorMsg = 'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼š';
                if (error.message.includes('åŒ¿åç™»å½•åŠŸèƒ½æœªå¯ç”¨')) {
                    errorMsg = error.message;
                } else if (error.message.includes('env') || error.message.includes('not found')) {
                    errorMsg = 'ç¯å¢ƒIDé”™è¯¯ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚å½“å‰EnvID: ' + TCB_ENV_ID;
                } else if (error.message.includes('timeout')) {
                    errorMsg = 'è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é¡µé¢é‡è¯•ã€‚';
                } else if (error.message.includes('permission')) {
                    errorMsg = 'æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“é›†åˆæƒé™è®¾ç½®ã€‚';
                } else {
                    errorMsg += error.message;
                }
                
                showMessage(errorMsg, 'error', 10000);
                return false;
                
            } finally {
                isInitializing = false;
            }
        }
        
        // ç¡®ä¿å·²ç™»å½•å¹¶åˆå§‹åŒ–
        async function ensureInitialized() {
            if (!app) {
                console.log('âš ï¸ ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œå¼€å§‹åˆå§‹åŒ–...');
                return await initTCB();
            }
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            try {
                const authState = await app.auth().getLoginState();
                if (!authState) {
                    console.log('âš ï¸ ç™»å½•çŠ¶æ€ä¸¢å¤±ï¼Œé‡æ–°ç™»å½•...');
                    await app.auth().signInAnonymously();
                }
                return true;
            } catch (error) {
                console.error('ç™»å½•çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                return await initTCB();
            }
        }
        
        // è¡¨å•æäº¤å¤„ç†
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            const rating = document.getElementById('rating').value;
            if (!rating) {
                showMessage('è¯·é€‰æ‹©æ»¡æ„åº¦è¯„åˆ†ï¼', 'error', 3000);
                document.getElementById('rating').focus();
                return;
            }
            
            // ç¡®ä¿ç³»ç»Ÿå·²åˆå§‹åŒ–
            const isReady = await ensureInitialized();
            if (!isReady) {
                showMessage('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚', 'error', 5000);
                return;
            }
            
            // è®¾ç½®åŠ è½½çŠ¶æ€
            setButtonState(true);
            
            // æ”¶é›†æ•°æ®
            const formData = new FormData(form);
            const now = new Date();
            const data = {
                name: formData.get('name')?.trim() || 'åŒ¿åç”¨æˆ·',
                rating: parseInt(rating),
                feedback: formData.get('feedback')?.trim() || '',
                submitted_at: now,
                createTime: now,
                timestamp: now.getTime()
            };
            
            console.log('ğŸ“¤ æäº¤æ•°æ®:', data);
            showMessage('æ­£åœ¨æäº¤æ‚¨çš„åé¦ˆï¼Œè¯·ç¨å€™...', 'loading');
            
            try {
                // æ’å…¥æ•°æ®åˆ°æ•°æ®åº“
                console.log('ğŸ“¡ å†™å…¥æ•°æ®åº“...');
                const startTime = Date.now();
                
                const result = await collection.add(data);
                const endTime = Date.now();
                
                console.log(`âœ… æäº¤æˆåŠŸï¼æ–‡æ¡£ID: ${result.id}, è€—æ—¶: ${endTime - startTime}ms`);
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showMessage(`
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="font-size:24px;">ğŸ‰</div>
                        <div>
                            <strong>æäº¤æˆåŠŸï¼</strong><br>
                            æ„Ÿè°¢æ‚¨çš„å®è´µåé¦ˆï¼Œæˆ‘ä»¬å·²ç»æ”¶åˆ°æ‚¨çš„é—®å·ã€‚
                        </div>
                    </div>
                `, 'success');
                
                // é‡ç½®è¡¨å•
                setTimeout(() => {
                    form.reset();
                    // 5ç§’åéšè—æ¶ˆæ¯
                    setTimeout(() => {
                        messageEl.style.display = 'none';
                    }, 5000);
                }, 1000);
                
            } catch (error) {
                console.error('âŒ æäº¤å¤±è´¥:', error);
                
                let errorMsg = 'æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                if (error.message.includes('permission')) {
                    errorMsg = 'æ•°æ®åº“æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥é›†åˆæƒé™è®¾ç½®ã€‚';
                } else if (error.message.includes('network') || error.message.includes('Failed') || error.message.includes('fetch')) {
                    errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å®‰å…¨åŸŸåé…ç½®ã€‚';
                } else if (error.message.includes('collection')) {
                    errorMsg = 'æ•°æ®åº“é›†åˆä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥é›†åˆåç§°ã€‚';
                } else if (error.message.includes('timeout')) {
                    errorMsg = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚';
                }
                
                showMessage(`
                    <strong>${errorMsg}</strong><br>
                    <small style="opacity:0.8;">é”™è¯¯è¯¦æƒ…: ${error.message.substring(0, 100)}</small>
                `, 'error');
                
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                setButtonState(false);
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–ç³»ç»Ÿ...');
            
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œè®©é¡µé¢å…ˆæ˜¾ç¤º
            setTimeout(async () => {
                await initTCB();
            }, 500);
        });
        
        console.log('ğŸ¯ é—®å·ç³»ç»Ÿè„šæœ¬åŠ è½½å®Œæˆ');
    </script>
</body>
</html>
